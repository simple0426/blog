---
title: 跨主机容器互连
date: 2019-11-12 17:01:04
tags: 
    - 容器互连
categories: ['虚拟化']
---
# 静态路由方式
>阿里云ecs需要在vpc上添加静态路由

* 案例
    - 主机192.168.99.101  docker容器网络172.18.0.1/16
    - 主机192.168.99.102  docker容器网络172.17.0.1/16
* 操作：
    - 101主机：route add -net 172.17.0.0/16 gw 192.168.99.102
    - 102主机：route add -net 172.18.0.0/16 gw 192.168.99.101

# ovs实现
* ovs（open vswitch）：overlay网络的实现
* ovs封装方式：
    - vxlan：udp报文封装
    - gre：点对点tcp报文封装

## 架构设计
|                  192.168.99.102                  |                             192.168.99.101                            |
|--------------------------------------------------|-----------------------------------------------------------------------|
| ubuntu                                           | centos7                                                               |
| ovs安装方式： apt-get install openvswitch-switch | 安装参考：http://blog.csdn.net/xinxing__8185/article/details/51900444 |
| 使用默认的docker0，网络为172.17.0.0              | 使用自定义网桥bridge0，网络为172.18.0.0                               |

## 102主机操作
```
ovs-vsctl add-br br0                   #添加名称为br0的ovs网桥
ovs-vsctl add-port br0 gre0 -- set interface gre0 type=gre options:remote_ip=192.168.99.101 #创建到另一台主机的gre tunnel
brctl addif docker0 br0              #将br0网桥添加到docker0网桥中
ip link set dev br0 up                 #启动br0
ip link set dev docker0 up    #启动docker0
ip route add 172.18.0.0/16 dev docker0        #添加到172.18.0.0/16的路由，使其通过docker0
service docker restart                #重启docker
docker start mysql-instance       #启动容器
```
## 101主机操作
```
ovs-vsctl add-br br0
ovs-vsctl add-port br0 gre0 -- set interface gre0 type=gre options:remote_ip=192.168.99.102
brctl addif bridge0 br0
ip link set dev br0 up
ip link set dev bridge0 up
ip route add 172.17.0.0/16 dev bridge0
systemctl restart docker.service
docker start  registry
```
## 持久化设置
>以centos7为例

* 建立网桥文件(/etc/sysconfig/network-scripts/ifcfg-bridge0)

```
ONBOOT=yes
BOOTPROTO=static
IPADDR=172.18.0.1
NETMASK=255.255.0.0
GATEWAY=172.18.0.0
USERCTL=no
TYPE=Bridge
DEVICE=bridge0
IPV6INIT=no
```

* 其他设置(/etc/rc.local)

```
ip route del 172.17.0.0/16 dev bridge0
brctl addif bridge0 br0
ip link set dev br0 up
```

* 保证rc.local执行：chmod +x /etc/rc.d/rc.local
