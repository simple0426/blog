---
title: redis服务端
tags:
categories:
---
# 复制
## 同异步
* 异步：redis复制是异步的，主会实时发送操作的命令到从机
* 部分同步：主从复制出现异常，重连进行同步时，支持部分同步（repl-backlog-size）
    - 可以通过rdb文件（非aof）实现部分同步功能（例如从机重启或升级时，可以SHUTDOWN（save & quit）保存数据）
* 同步：使用WAIT可以支持同步复制

## 主从架构
* 主可以有多个从（从机只读），可以分担主的读压力，同时增加数据安全性
* 从也可以有从，即可以构成级联架构，此时sub-slave从master接收复制流
* 主从结构
    - 为了安全性，主应当开启数据持久化（rdb、aof）
    - 如果主没有开启持久化，而从开启了持久化时，当主机重启，由于内存数据丢失，重启后复制流也会删除从机的数据

## 非阻塞式
* 在master端，复制是非阻塞式的
* 在slave端，大部分情况下，复制是非阻塞的；
    - 在同步初始化阶段，可以配置允许从机向客户端提供旧的数据（slave-serve-stale-data ）以避免阻塞
    - 在同步后，依然会有一小段阻塞时间（4.0之前删除数据、加载新的数据都会阻塞；4.0之后会用单独的线程执行删除操作，但是加载数据依然会阻塞）

## 复制选项
* 无盘复制：repl-diskless-sync
* 只读设置：slave-read-only
    - 如果从机可写，在4.0之前会存在内存泄漏（key过期，客户端不可见，但依然在内存中）
    - 4.0之后的版本，当数据库序列小于63时，不会出现内存泄漏
    - 4.0之后的版本，从机只是本地可写，即不会将变更传递给它的从机（sub-slave从master接收复制流）
* 连接设置：
    - slaveof 192.168.1.1 6379
    - masterauth password
* 少于指定数量主机或大于某个延迟时停止写操作
    - min-slaves-to-write 3
    - min-slaves-max-lag 10
* nat和端口转发环境下的配置（docker）
    - slave-announce-ip
    - slave-announce-port

## 过期key处理
* 从机处理过期key的方式
    - 不依赖于主从间的同步时钟
    - 从主上接收处理过期的命令（del）
    - 为了保持数据一致性，对于应当删除而没有删除的key，从机返回错误
    - 在lua脚本执行期间，主的数据会被冻结，不会产生过期删除操作

## 状态查看
- INFO replication
- ROLE

# 使用建议
* 设置允许过量使用内存：vm.overcommit_memory = 1
